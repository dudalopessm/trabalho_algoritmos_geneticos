import time
import numpy as np
import pandas as pd
from sklearn.preprocessing import PowerTransformer, QuantileTransformer
from sklearn.neighbors import KNeighborsClassifier
import os
import shutil
from src.utils.constants import (
    IMAGE_DATASET_PATH,
    RETRIEVED_IMAGES_PATH,
    CSV_FILE_PATH,
    IMAGE_FILE_EXTENSION,
    K_NEIGHBORS,
)


def load_histograms_from_csv(csv_file_path, method="yeo-johnson", standardize=True):
    """
    Loads image histograms from CSV, removes zero/constant columns, and applies
    transformation. Uses QuantileTransformer if PowerTransformer fails.

    Args:
        csv_file_path (str): Path to the CSV file.
        method (str): 'yeo-johnson', 'box-cox', or 'quantile'.
        standardize (bool): Standardize data after transformation.

    Returns:
        np.ndarray: Transformed histograms or empty array if no valid columns.
    """
    # Load data
    histograms_df = pd.read_csv(csv_file_path, header=None)

    # Remove all-zero columns
    non_zero_columns_df = histograms_df.loc[:, (histograms_df != 0).any(axis=0)]

    # Remove constant columns (zero variance)
    non_constant_columns_df = non_zero_columns_df.loc[:, non_zero_columns_df.std() > 0]

    # Initialize result as empty array for edge cases
    result = np.array([])

    # Only process if we have valid columns
    if non_constant_columns_df.shape[1] > 0:
        try:
            if method in ["box-cox", "yeo-johnson"]:
                transformer = PowerTransformer(method=method, standardize=standardize)
                result = transformer.fit_transform(non_constant_columns_df)
            else:
                qt = QuantileTransformer(output_distribution="normal", random_state=0)
                result = qt.fit_transform(non_constant_columns_df)
        except Exception as e:
            print(f"Transformation failed ({e}), using fallback QuantileTransformer")
            qt = QuantileTransformer(output_distribution="normal", random_state=0)
            result = qt.fit_transform(non_constant_columns_df)

    # SELECTED_COLUMNS = [
    #     14,
    #     18,
    #     20,
    #     27,
    #     30,
    #     31,
    #     39,
    #     48,
    #     53,
    #     60,
    #     66,
    #     67,
    #     71,
    #     73,
    #     74,
    #     78,
    #     79,
    #     87,
    #     89,
    #     91,
    #     92,
    #     93,
    #     97,
    #     98,
    #     99,
    #     104,
    #     107,
    #     118,
    #     132,
    #     136,
    #     144,
    #     163,
    #     167,
    #     170,
    #     174,
    #     183,
    #     187,
    #     189,
    #     199,
    #     212,
    #     216,
    #     217,
    #     223,
    #     224,
    #     227,
    #     232,
    #     238,
    #     241,
    #     247,
    #     248,
    #     257,
    #     258,
    #     261,
    #     265,
    #     267,
    #     270,
    #     273,
    #     274,
    #     279,
    #     283,
    #     284,
    #     286,
    #     287,
    #     289,
    #     292,
    #     301,
    #     305,
    #     309,
    #     310,
    #     311,
    #     313,
    #     315,
    #     319,
    #     322,
    #     324,
    #     326,
    #     327,
    #     330,
    #     335,
    #     336,
    #     338,
    #     339,
    #     342,
    #     345,
    #     347,
    #     348,
    #     354,
    #     355,
    #     357,
    #     358,
    #     361,
    #     362,
    #     364,
    #     365,
    #     366,
    #     367,
    #     368,
    #     370,
    #     372,
    #     376,
    #     381,
    #     384,
    #     388,
    #     390,
    #     391,
    #     392,
    #     395,
    #     399,
    #     400,
    #     401,
    #     402,
    #     408,
    #     410,
    #     413,
    #     414,
    #     415,
    #     418,
    #     423,
    #     425,
    #     426,
    #     427,
    #     429,
    #     432,
    #     435,
    #     436,
    #     439,
    #     442,
    #     444,
    #     445,
    #     446,
    #     450,
    #     451,
    #     452,
    #     454,
    #     456,
    #     459,
    #     460,
    #     462,
    #     463,
    #     465,
    #     467,
    #     470,
    #     471,
    #     473,
    #     474,
    #     476,
    #     477,
    #     478,
    #     481,
    #     483,
    #     487,
    #     489,
    #     492,
    #     493,
    #     494,
    #     498,
    #     499,
    #     500,
    #     502,
    #     506,
    #     507,
    #     512,
    #     514,
    #     517,
    #     518,
    #     520,
    #     528,
    #     532,
    #     533,
    #     541,
    #     542,
    #     544,
    #     545,
    #     546,
    #     547,
    #     550,
    #     552,
    #     556,
    #     561,
    #     563,
    #     566,
    #     568,
    #     570,
    #     574,
    #     576,
    #     577,
    #     579,
    #     582,
    #     589,
    #     594,
    #     595,
    #     596,
    #     598,
    #     599,
    #     600,
    #     602,
    #     603,
    #     607,
    #     609,
    #     610,
    #     619,
    #     620,
    #     633,
    #     642,
    #     644,
    #     645,
    #     648,
    #     650,
    #     651,
    #     652,
    #     653,
    #     654,
    #     655,
    #     656,
    #     657,
    #     662,
    #     666,
    #     667,
    #     669,
    #     670,
    #     671,
    #     675,
    #     676,
    #     677,
    #     678,
    #     679,
    #     680,
    #     684,
    #     695,
    #     696,
    #     698,
    #     699,
    #     702,
    #     703,
    #     704,
    #     705,
    #     710,
    #     713,
    #     714,
    #     717,
    #     718,
    #     720,
    #     724,
    #     725,
    #     727,
    #     728,
    #     729,
    #     732,
    #     742,
    #     744,
    #     745,
    #     747,
    #     751,
    #     753,
    #     757,
    #     761,
    #     762,
    #     772,
    #     773,
    #     775,
    #     779,
    #     782,
    #     790,
    #     791,
    #     793,
    #     794,
    #     796,
    #     801,
    #     803,
    #     804,
    #     805,
    #     822,
    #     823,
    #     828,
    #     829,
    #     831,
    #     844,
    #     846,
    #     847,
    #     849,
    #     850,
    #     853,
    #     854,
    #     857,
    #     858,
    #     859,
    #     864,
    #     870,
    #     875,
    #     876,
    #     881,
    #     882,
    #     883,
    #     895,
    #     899,
    #     900,
    #     906,
    #     908,
    #     922,
    #     923,
    #     924,
    #     926,
    #     927,
    #     928,
    #     937,
    #     938,
    #     942,
    #     944,
    #     957,
    #     959,
    #     961,
    #     969,
    #     971,
    #     974,
    #     975,
    #     976,
    #     983,
    #     986,
    #     987,
    #     992,
    #     993,
    #     1000,
    #     1001,
    #     1002,
    #     1004,
    #     1011,
    #     1012,
    #     1013,
    #     1016,
    #     1022,
    #     1026,
    #     1027,
    #     1029,
    #     1041,
    #     1043,
    #     1045,
    #     1049,
    #     1050,
    #     1052,
    #     1054,
    #     1063,
    #     1064,
    #     1066,
    #     1067,
    #     1072,
    #     1074,
    #     1076,
    #     1081,
    #     1084,
    #     1085,
    #     1089,
    #     1091,
    #     1092,
    #     1093,
    #     1098,
    #     1104,
    #     1105,
    #     1107,
    #     1114,
    #     1116,
    #     1117,
    #     1119,
    #     1120,
    #     1121,
    #     1122,
    #     1125,
    #     1126,
    #     1128,
    #     1129,
    #     1133,
    #     1140,
    #     1143,
    #     1146,
    #     1149,
    #     1156,
    #     1159,
    #     1161,
    #     1163,
    #     1168,
    #     1169,
    #     1171,
    #     1174,
    #     1175,
    #     1176,
    #     1178,
    #     1185,
    #     1186,
    #     1187,
    #     1189,
    #     1190,
    #     1191,
    #     1193,
    #     1194,
    #     1196,
    #     1197,
    #     1198,
    #     1200,
    #     1205,
    #     1206,
    #     1214,
    #     1216,
    #     1217,
    #     1218,
    #     1219,
    #     1222,
    #     1223,
    #     1224,
    #     1227,
    #     1228,
    #     1229,
    #     1240,
    #     1245,
    #     1247,
    #     1248,
    #     1263,
    #     1265,
    #     1269,
    #     1270,
    #     1271,
    #     1275,
    #     1277,
    #     1280,
    #     1282,
    #     1284,
    #     1290,
    #     1291,
    #     1293,
    #     1294,
    #     1295,
    #     1296,
    #     1298,
    #     1299,
    #     1300,
    #     1301,
    #     1302,
    #     1303,
    #     1304,
    #     1306,
    #     1312,
    #     1318,
    #     1322,
    #     1324,
    #     1325,
    #     1329,
    #     1330,
    #     1331,
    #     1332,
    #     1335,
    #     1338,
    #     1341,
    #     1343,
    #     1346,
    #     1347,
    #     1348,
    #     1349,
    #     1350,
    #     1352,
    #     1353,
    #     1356,
    #     1358,
    #     1370,
    #     1371,
    #     1372,
    #     1377,
    #     1384,
    #     1386,
    #     1387,
    #     1388,
    #     1391,
    #     1393,
    #     1395,
    #     1396,
    #     1398,
    #     1419,
    #     1423,
    #     1424,
    #     1428,
    #     1430,
    #     1431,
    #     1437,
    #     1444,
    #     1448,
    #     1454,
    #     1455,
    #     1456,
    #     1457,
    #     1458,
    #     1459,
    #     1464,
    #     1470,
    #     1471,
    #     1472,
    #     1484,
    #     1485,
    #     1486,
    #     1488,
    #     1490,
    #     1491,
    #     1492,
    #     1493,
    #     1494,
    #     1496,
    #     1497,
    #     1498,
    #     1499,
    #     1501,
    #     1502,
    #     1507,
    #     1509,
    #     1512,
    #     1517,
    #     1518,
    #     1520,
    #     1521,
    #     1525,
    #     1526,
    #     1527,
    #     1528,
    #     1529,
    #     1531,
    #     1532,
    #     1533,
    #     1534,
    #     1535,
    #     1536,
    #     1537,
    #     1538,
    #     1544,
    #     1548,
    #     1550,
    #     1551,
    #     1554,
    #     1557,
    #     1560,
    #     1561,
    #     1562,
    #     1563,
    #     1564,
    #     1565,
    #     1566,
    #     1568,
    #     1570,
    #     1574,
    #     1575,
    #     1577,
    #     1580,
    #     1581,
    #     1582,
    #     1591,
    #     1593,
    #     1596,
    #     1597,
    #     1602,
    #     1604,
    #     1606,
    #     1607,
    #     1610,
    #     1612,
    #     1614,
    #     1615,
    #     1618,
    #     1620,
    #     1623,
    #     1626,
    #     1627,
    #     1629,
    #     1636,
    #     1637,
    #     1639,
    #     1640,
    #     1641,
    #     1643,
    #     1644,
    #     1645,
    #     1649,
    #     1650,
    #     1652,
    #     1653,
    #     1654,
    #     1658,
    #     1660,
    #     1661,
    #     1664,
    #     1673,
    #     1674,
    #     1675,
    #     1676,
    #     1678,
    #     1681,
    #     1684,
    #     1686,
    #     1690,
    #     1692,
    #     1693,
    #     1694,
    #     1695,
    #     1696,
    #     1701,
    #     1702,
    #     1705,
    #     1707,
    #     1708,
    #     1709,
    #     1711,
    #     1712,
    #     1714,
    #     1715,
    #     1717,
    #     1720,
    #     1722,
    #     1726,
    #     1728,
    #     1729,
    #     1731,
    #     1735,
    #     1737,
    #     1738,
    #     1739,
    #     1741,
    #     1742,
    #     1747,
    #     1750,
    #     1751,
    #     1752,
    #     1758,
    #     1764,
    #     1765,
    #     1767,
    #     1771,
    #     1772,
    #     1773,
    #     1774,
    #     1777,
    #     1778,
    #     1779,
    #     1780,
    #     1783,
    #     1784,
    #     1786,
    #     1787,
    #     1789,
    #     1792,
    #     1795,
    #     1798,
    #     1801,
    #     1803,
    #     1807,
    #     1810,
    #     1813,
    #     1816,
    #     1817,
    #     1818,
    #     1823,
    #     1825,
    #     1829,
    #     1830,
    #     1831,
    #     1836,
    #     1837,
    #     1839,
    #     1840,
    #     1843,
    #     1844,
    #     1847,
    #     1848,
    #     1849,
    #     1850,
    #     1851,
    #     1853,
    #     1854,
    #     1855,
    #     1858,
    #     1859,
    #     1861,
    #     1870,
    #     1872,
    #     1873,
    #     1879,
    #     1882,
    #     1883,
    #     1885,
    #     1888,
    #     1889,
    #     1890,
    #     1895,
    #     1896,
    #     1903,
    #     1914,
    #     1916,
    #     1919,
    #     1921,
    #     1922,
    #     1925,
    #     1926,
    #     1928,
    #     1931,
    #     1932,
    #     1933,
    #     1935,
    #     1936,
    #     1938,
    #     1941,
    #     1944,
    #     1945,
    #     1951,
    #     1957,
    #     1964,
    #     1968,
    #     1971,
    #     1973,
    #     1974,
    #     1978,
    #     1979,
    #     1984,
    #     1986,
    #     1992,
    #     1993,
    #     1994,
    #     1995,
    #     1996,
    #     1999,
    #     2004,
    #     2006,
    #     2007,
    #     2009,
    #     2019,
    #     2020,
    #     2021,
    #     2024,
    #     2025,
    #     2029,
    #     2030,
    #     2031,
    #     2036,
    #     2037,
    #     2039,
    #     2040,
    #     2042,
    #     2044,
    #     2051,
    #     2052,
    #     2056,
    #     2059,
    #     2061,
    #     2062,
    #     2065,
    #     2066,
    #     2067,
    #     2068,
    #     2070,
    #     2071,
    #     2072,
    #     2073,
    #     2074,
    #     2076,
    #     2077,
    #     2078,
    #     2080,
    #     2089,
    #     2091,
    #     2092,
    #     2094,
    #     2095,
    #     2096,
    #     2098,
    #     2101,
    #     2102,
    #     2105,
    #     2107,
    #     2108,
    #     2109,
    #     2113,
    #     2115,
    #     2120,
    #     2124,
    #     2125,
    #     2128,
    #     2133,
    #     2134,
    #     2135,
    #     2137,
    #     2138,
    #     2139,
    #     2147,
    #     2148,
    #     2154,
    #     2160,
    #     2166,
    #     2173,
    #     2174,
    #     2176,
    #     2181,
    #     2184,
    #     2190,
    #     2199,
    #     2215,
    #     2216,
    #     2217,
    #     2223,
    #     2224,
    #     2227,
    #     2229,
    #     2231,
    #     2233,
    #     2234,
    #     2236,
    #     2237,
    #     2238,
    #     2239,
    #     2240,
    #     2242,
    #     2243,
    #     2244,
    #     2247,
    #     2249,
    #     2250,
    #     2251,
    #     2252,
    #     2253,
    #     2258,
    #     2260,
    #     2266,
    #     2268,
    #     2269,
    #     2271,
    #     2272,
    #     2273,
    #     2275,
    #     2279,
    #     2281,
    #     2282,
    #     2285,
    #     2286,
    #     2287,
    #     2288,
    #     2289,
    #     2290,
    #     2291,
    #     2294,
    #     2295,
    #     2298,
    #     2300,
    #     2302,
    #     2303,
    #     2304,
    #     2307,
    #     2309,
    #     2312,
    #     2313,
    #     2319,
    #     2323,
    #     2325,
    #     2327,
    #     2328,
    #     2329,
    #     2334,
    #     2340,
    #     2341,
    #     2345,
    #     2346,
    #     2355,
    #     2362,
    #     2364,
    #     2366,
    #     2371,
    #     2372,
    #     2375,
    #     2376,
    #     2379,
    #     2382,
    #     2383,
    #     2386,
    #     2388,
    #     2389,
    #     2390,
    #     2392,
    #     2394,
    #     2396,
    #     2401,
    #     2402,
    #     2404,
    #     2405,
    #     2408,
    #     2409,
    #     2410,
    #     2412,
    #     2413,
    #     2415,
    #     2418,
    #     2421,
    #     2424,
    #     2428,
    #     2431,
    #     2432,
    #     2436,
    #     2437,
    #     2444,
    #     2446,
    #     2449,
    #     2451,
    #     2454,
    #     2459,
    #     2460,
    #     2461,
    #     2464,
    #     2465,
    #     2467,
    #     2468,
    #     2471,
    #     2472,
    #     2473,
    #     2475,
    #     2478,
    #     2480,
    #     2482,
    #     2483,
    #     2485,
    #     2491,
    #     2492,
    #     2498,
    #     2501,
    #     2502,
    #     2503,
    #     2507,
    #     2513,
    #     2514,
    #     2515,
    #     2519,
    #     2528,
    #     2529,
    #     2530,
    #     2531,
    #     2532,
    #     2533,
    #     2535,
    #     2536,
    #     2537,
    #     2538,
    #     2540,
    #     2542,
    #     2543,
    #     2547,
    #     2548,
    #     2550,
    #     2552,
    #     2559,
    #     2561,
    #     2562,
    #     2566,
    #     2567,
    #     2569,
    #     2581,
    #     2582,
    #     2583,
    #     2584,
    #     2585,
    #     2589,
    #     2591,
    #     2592,
    #     2593,
    #     2594,
    #     2596,
    #     2598,
    #     2599,
    #     2600,
    #     2601,
    #     2602,
    #     2603,
    #     2605,
    #     2606,
    #     2609,
    #     2610,
    #     2612,
    #     2613,
    #     2614,
    #     2615,
    #     2620,
    #     2621,
    #     2623,
    #     2626,
    #     2633,
    #     2638,
    #     2643,
    #     2644,
    #     2647,
    #     2648,
    #     2650,
    #     2651,
    #     2657,
    #     2659,
    #     2663,
    #     2664,
    #     2665,
    #     2668,
    #     2669,
    #     2670,
    #     2671,
    #     2672,
    #     2673,
    #     2677,
    #     2678,
    #     2679,
    #     2683,
    #     2687,
    #     2694,
    #     2696,
    #     2697,
    #     2701,
    #     2702,
    #     2704,
    #     2708,
    #     2709,
    #     2710,
    #     2712,
    #     2713,
    #     2717,
    #     2718,
    #     2721,
    #     2723,
    #     2726,
    #     2728,
    #     2729,
    #     2731,
    #     2734,
    #     2735,
    #     2737,
    #     2738,
    #     2741,
    #     2743,
    #     2744,
    #     2747,
    #     2752,
    #     2753,
    #     2763,
    #     2766,
    #     2769,
    #     2777,
    #     2779,
    #     2785,
    #     2791,
    #     2794,
    #     2795,
    #     2798,
    #     2800,
    #     2801,
    #     2805,
    #     2814,
    #     2818,
    #     2819,
    #     2825,
    #     2828,
    #     2834,
    #     2835,
    #     2841,
    #     2842,
    #     2846,
    #     2847,
    #     2848,
    #     2849,
    #     2850,
    #     2851,
    #     2854,
    #     2856,
    #     2867,
    #     2874,
    #     2876,
    #     2878,
    #     2880,
    #     2883,
    #     2885,
    #     2886,
    #     2888,
    #     2892,
    #     2897,
    #     2899,
    #     2903,
    #     2905,
    #     2906,
    #     2909,
    #     2911,
    #     2912,
    #     2913,
    #     2915,
    #     2920,
    # ]

    # selected_data = result[:, SELECTED_COLUMNS]

    # SELECTED_COLUMNS = [
    #     4,
    #     7,
    #     8,
    #     10,
    #     11,
    #     13,
    #     14,
    #     15,
    #     16,
    #     20,
    #     22,
    #     26,
    #     27,
    #     28,
    #     29,
    #     30,
    #     32,
    #     38,
    #     40,
    #     49,
    #     51,
    #     53,
    #     57,
    #     58,
    #     59,
    #     60,
    #     62,
    #     64,
    #     67,
    #     68,
    #     70,
    #     71,
    #     79,
    #     84,
    #     86,
    #     88,
    #     89,
    #     91,
    #     94,
    #     95,
    #     97,
    #     100,
    #     102,
    #     104,
    #     107,
    #     108,
    #     109,
    #     110,
    #     114,
    #     115,
    #     116,
    #     118,
    #     119,
    #     121,
    #     122,
    #     123,
    #     126,
    #     129,
    #     130,
    #     131,
    #     132,
    #     135,
    #     137,
    #     138,
    #     141,
    #     142,
    #     145,
    #     147,
    #     148,
    #     149,
    #     152,
    #     156,
    #     158,
    #     162,
    #     163,
    #     164,
    #     165,
    #     167,
    #     169,
    #     173,
    #     179,
    #     181,
    #     183,
    #     185,
    #     186,
    #     189,
    #     191,
    #     192,
    #     193,
    #     200,
    #     201,
    #     202,
    #     203,
    #     206,
    #     209,
    #     210,
    #     211,
    #     214,
    #     216,
    #     217,
    #     219,
    #     220,
    #     222,
    #     223,
    #     224,
    #     225,
    #     227,
    #     231,
    #     232,
    #     233,
    #     238,
    #     239,
    #     243,
    #     244,
    #     245,
    #     246,
    #     251,
    #     257,
    #     258,
    #     261,
    #     262,
    #     271,
    #     272,
    #     275,
    #     277,
    #     280,
    #     289,
    #     290,
    #     291,
    #     292,
    #     293,
    #     296,
    #     297,
    #     298,
    #     305,
    #     307,
    #     310,
    #     312,
    #     313,
    #     316,
    #     317,
    #     319,
    #     320,
    #     322,
    #     323,
    #     324,
    #     325,
    #     326,
    #     327,
    #     330,
    #     332,
    #     336,
    #     338,
    #     339,
    #     341,
    #     346,
    #     348,
    #     350,
    #     351,
    #     352,
    #     354,
    #     356,
    #     357,
    #     360,
    #     362,
    #     364,
    #     365,
    #     371,
    #     372,
    #     376,
    #     378,
    #     379,
    #     383,
    #     387,
    #     393,
    #     394,
    #     398,
    #     400,
    #     401,
    #     402,
    #     403,
    #     408,
    #     409,
    #     411,
    #     413,
    #     417,
    #     418,
    #     421,
    #     422,
    #     425,
    #     429,
    #     431,
    #     433,
    #     434,
    #     436,
    #     438,
    #     440,
    #     441,
    #     443,
    #     445,
    #     448,
    #     453,
    #     455,
    #     456,
    #     457,
    #     465,
    #     466,
    #     468,
    #     470,
    #     473,
    #     474,
    #     475,
    #     477,
    #     478,
    #     480,
    #     481,
    #     483,
    #     484,
    #     485,
    #     489,
    #     493,
    #     498,
    #     499,
    #     501,
    #     505,
    #     508,
    #     511,
    #     516,
    #     517,
    #     519,
    #     520,
    #     521,
    #     527,
    #     529,
    #     531,
    #     534,
    #     536,
    #     537,
    #     538,
    #     539,
    #     542,
    #     546,
    #     548,
    #     549,
    #     550,
    #     551,
    #     552,
    #     557,
    #     558,
    #     563,
    #     564,
    #     565,
    #     566,
    #     567,
    #     568,
    #     571,
    #     572,
    #     573,
    #     574,
    #     579,
    #     584,
    #     586,
    #     587,
    #     589,
    #     592,
    #     595,
    #     596,
    #     597,
    #     599,
    #     600,
    #     601,
    #     602,
    #     607,
    #     608,
    #     610,
    #     614,
    #     615,
    #     616,
    #     619,
    #     622,
    #     626,
    #     632,
    #     635,
    #     639,
    #     641,
    #     644,
    #     648,
    #     649,
    #     650,
    #     651,
    #     655,
    #     659,
    #     660,
    #     662,
    #     664,
    #     665,
    #     666,
    #     670,
    #     672,
    #     673,
    #     675,
    #     676,
    #     679,
    #     684,
    #     685,
    #     689,
    #     692,
    #     694,
    #     698,
    #     699,
    #     706,
    #     707,
    #     708,
    #     710,
    #     711,
    #     713,
    #     714,
    #     715,
    #     718,
    #     720,
    #     723,
    #     734,
    #     735,
    #     736,
    #     737,
    #     740,
    #     741,
    #     743,
    #     746,
    #     747,
    #     749,
    #     751,
    #     752,
    #     757,
    #     758,
    #     759,
    #     760,
    #     761,
    #     767,
    #     770,
    #     773,
    #     774,
    #     777,
    #     781,
    #     783,
    #     795,
    #     796,
    #     797,
    #     798,
    #     799,
    #     800,
    #     801,
    #     802,
    #     807,
    #     809,
    #     811,
    #     814,
    #     815,
    #     816,
    #     817,
    #     818,
    #     825,
    #     826,
    #     830,
    #     831,
    #     833,
    #     835,
    #     838,
    #     839,
    #     841,
    #     843,
    #     844,
    #     847,
    #     851,
    #     852,
    #     854,
    #     855,
    #     857,
    #     860,
    #     861,
    #     862,
    #     863,
    #     864,
    #     865,
    #     868,
    #     869,
    #     872,
    #     873,
    #     875,
    #     877,
    #     879,
    #     880,
    #     881,
    #     883,
    #     884,
    #     885,
    #     886,
    #     887,
    #     888,
    #     889,
    #     894,
    #     895,
    #     898,
    #     899,
    #     900,
    #     901,
    #     902,
    #     903,
    #     906,
    #     907,
    #     909,
    #     910,
    #     911,
    #     913,
    #     915,
    #     916,
    #     919,
    #     921,
    #     927,
    #     930,
    #     931,
    #     932,
    #     934,
    #     936,
    #     937,
    #     939,
    #     940,
    #     941,
    #     947,
    #     951,
    #     952,
    #     959,
    #     961,
    #     962,
    #     963,
    #     967,
    #     968,
    #     969,
    #     970,
    #     971,
    #     975,
    #     976,
    #     979,
    #     980,
    #     991,
    #     994,
    #     996,
    #     1000,
    #     1002,
    #     1003,
    #     1007,
    #     1008,
    #     1009,
    #     1010,
    #     1012,
    #     1013,
    #     1024,
    #     1025,
    #     1026,
    #     1028,
    #     1030,
    #     1031,
    #     1032,
    #     1037,
    #     1038,
    #     1040,
    #     1041,
    #     1042,
    #     1043,
    #     1044,
    #     1047,
    #     1050,
    #     1056,
    #     1058,
    #     1059,
    #     1062,
    #     1068,
    #     1069,
    #     1070,
    #     1072,
    #     1077,
    #     1079,
    #     1080,
    #     1082,
    #     1083,
    # ]

    # selected_data = selected_data[:, SELECTED_COLUMNS]

    # SELECTED_COLUMNS = [
    #     0,
    #     1,
    #     2,
    #     3,
    #     5,
    #     6,
    #     7,
    #     9,
    #     11,
    #     12,
    #     13,
    #     14,
    #     16,
    #     19,
    #     21,
    #     22,
    #     24,
    #     25,
    #     27,
    #     28,
    #     29,
    #     31,
    #     32,
    #     33,
    #     34,
    #     36,
    #     37,
    #     38,
    #     39,
    #     40,
    #     42,
    #     43,
    #     44,
    #     45,
    #     46,
    #     47,
    #     48,
    #     49,
    #     51,
    #     53,
    #     54,
    #     56,
    #     57,
    #     58,
    #     59,
    #     60,
    #     62,
    #     63,
    #     65,
    #     66,
    #     67,
    #     70,
    #     71,
    #     72,
    #     73,
    #     74,
    #     75,
    #     76,
    #     77,
    #     79,
    #     80,
    #     81,
    #     82,
    #     83,
    #     86,
    #     88,
    #     89,
    #     90,
    #     91,
    #     92,
    #     93,
    #     95,
    #     96,
    #     98,
    #     99,
    #     100,
    #     102,
    #     106,
    #     107,
    #     108,
    #     109,
    #     110,
    #     111,
    #     113,
    #     115,
    #     116,
    #     118,
    #     123,
    #     124,
    #     125,
    #     126,
    #     127,
    #     128,
    #     130,
    #     131,
    #     134,
    #     136,
    #     137,
    #     138,
    #     139,
    #     140,
    #     141,
    #     144,
    #     145,
    #     147,
    #     148,
    #     150,
    #     152,
    #     154,
    #     155,
    #     156,
    #     161,
    #     164,
    #     165,
    #     167,
    #     168,
    #     170,
    #     171,
    #     173,
    #     175,
    #     177,
    #     178,
    #     180,
    #     182,
    #     185,
    #     187,
    #     188,
    #     189,
    #     190,
    #     191,
    #     192,
    #     193,
    #     195,
    #     196,
    #     197,
    #     198,
    #     199,
    #     201,
    #     203,
    #     205,
    #     206,
    #     208,
    #     210,
    #     213,
    #     216,
    #     217,
    #     220,
    #     221,
    #     223,
    #     224,
    #     227,
    #     228,
    #     229,
    #     230,
    #     231,
    #     232,
    #     233,
    #     234,
    #     235,
    #     236,
    #     237,
    #     238,
    #     239,
    #     240,
    #     241,
    #     242,
    #     244,
    #     245,
    #     246,
    #     248,
    #     249,
    #     250,
    #     253,
    #     255,
    #     256,
    #     257,
    #     258,
    #     259,
    #     260,
    #     263,
    #     264,
    #     265,
    #     270,
    #     272,
    #     273,
    #     276,
    #     277,
    #     280,
    #     281,
    #     283,
    #     284,
    #     285,
    #     286,
    #     287,
    #     289,
    #     294,
    #     295,
    #     296,
    #     297,
    #     298,
    #     299,
    #     300,
    #     301,
    #     303,
    #     304,
    #     305,
    #     306,
    #     307,
    #     308,
    #     310,
    #     311,
    #     314,
    #     315,
    #     316,
    #     318,
    #     319,
    #     320,
    #     321,
    #     323,
    #     325,
    #     326,
    #     327,
    #     328,
    #     329,
    #     330,
    #     331,
    #     332,
    #     333,
    #     336,
    #     337,
    #     338,
    #     339,
    #     340,
    #     341,
    #     344,
    #     346,
    #     351,
    #     352,
    #     355,
    #     356,
    #     357,
    #     358,
    #     359,
    #     361,
    #     362,
    #     364,
    #     365,
    #     366,
    #     367,
    #     369,
    #     370,
    #     372,
    #     375,
    #     378,
    #     380,
    #     381,
    #     382,
    #     383,
    #     384,
    #     385,
    #     386,
    #     388,
    #     390,
    #     391,
    #     392,
    #     393,
    #     394,
    #     395,
    #     396,
    #     397,
    #     398,
    #     400,
    #     401,
    #     404,
    #     407,
    #     408,
    #     410,
    #     411,
    #     414,
    #     416,
    #     417,
    #     419,
    #     420,
    #     422,
    #     423,
    #     426,
    #     427,
    #     428,
    #     432,
    #     433,
    #     434,
    #     435,
    #     438,
    #     439,
    #     440,
    #     441,
    #     443,
    #     446,
    #     448,
    #     450,
    #     453,
    #     454,
    #     455,
    #     456,
    #     458,
    #     460,
    #     462,
    #     464,
    #     466,
    #     467,
    #     470,
    #     471,
    #     472,
    #     474,
    #     475,
    #     476,
    #     478,
    #     479,
    #     480,
    #     481,
    #     483,
    # ]

    # selected_data = selected_data[:, SELECTED_COLUMNS]

    # SELECTED_COLUMNS = [
    #     0,
    #     1,
    #     3,
    #     4,
    #     5,
    #     6,
    #     7,
    #     8,
    #     9,
    #     11,
    #     12,
    #     13,
    #     16,
    #     19,
    #     20,
    #     21,
    #     22,
    #     23,
    #     24,
    #     25,
    #     26,
    #     28,
    #     30,
    #     31,
    #     33,
    #     34,
    #     35,
    #     36,
    #     38,
    #     40,
    #     41,
    #     42,
    #     43,
    #     45,
    #     46,
    #     47,
    #     50,
    #     51,
    #     54,
    #     55,
    #     56,
    #     57,
    #     58,
    #     59,
    #     60,
    #     62,
    #     63,
    #     64,
    #     65,
    #     66,
    #     67,
    #     69,
    #     70,
    #     71,
    #     72,
    #     73,
    #     74,
    #     75,
    #     76,
    #     77,
    #     78,
    #     79,
    #     80,
    #     81,
    #     82,
    #     83,
    #     84,
    #     85,
    #     86,
    #     87,
    #     90,
    #     92,
    #     93,
    #     95,
    #     96,
    #     97,
    #     98,
    #     99,
    #     100,
    #     101,
    #     104,
    #     106,
    #     108,
    #     110,
    #     111,
    #     113,
    #     114,
    #     115,
    #     116,
    #     117,
    #     121,
    #     122,
    #     123,
    #     124,
    #     125,
    #     126,
    #     127,
    #     128,
    #     129,
    #     130,
    #     131,
    #     132,
    #     134,
    #     135,
    #     137,
    #     138,
    #     139,
    #     140,
    #     141,
    #     142,
    #     144,
    #     145,
    #     147,
    #     148,
    #     149,
    #     150,
    #     151,
    #     152,
    #     154,
    #     155,
    #     156,
    #     157,
    #     158,
    #     159,
    #     160,
    #     161,
    #     163,
    #     164,
    #     165,
    #     166,
    #     167,
    #     168,
    #     169,
    #     170,
    #     171,
    #     173,
    #     174,
    #     175,
    #     176,
    #     177,
    #     178,
    #     179,
    #     180,
    #     181,
    #     182,
    #     183,
    #     184,
    #     186,
    #     187,
    #     188,
    #     189,
    #     190,
    #     192,
    #     193,
    #     195,
    #     196,
    #     199,
    #     200,
    #     202,
    #     203,
    #     204,
    #     205,
    #     206,
    #     207,
    #     208,
    #     210,
    #     211,
    #     212,
    #     213,
    #     216,
    #     217,
    #     218,
    #     219,
    #     221,
    #     222,
    #     223,
    #     225,
    #     226,
    #     227,
    #     229,
    #     230,
    #     232,
    #     234,
    #     235,
    #     236,
    #     238,
    #     239,
    #     240,
    #     241,
    #     242,
    #     244,
    #     246,
    #     247,
    #     248,
    #     250,
    #     252,
    #     253,
    #     254,
    #     255,
    #     256,
    #     257,
    #     258,
    #     260,
    #     262,
    #     263,
    #     264,
    #     266,
    #     267,
    #     268,
    #     269,
    #     270,
    #     271,
    #     273,
    #     274,
    #     275,
    #     276,
    #     277,
    #     279,
    #     280,
    #     281,
    #     282,
    #     283,
    #     284,
    #     285,
    #     287,
    #     288,
    #     289,
    #     291,
    #     292,
    #     293,
    #     294,
    #     295,
    #     296,
    #     298,
    #     299,
    #     300,
    #     301,
    #     302,
    #     303,
    #     304,
    #     305,
    #     306,
    #     307,
    #     308,
    #     309,
    #     311,
    #     312,
    #     313,
    #     314,
    #     315,
    #     316,
    #     317,
    #     318,
    #     319,
    #     320,
    # ]

    # selected_data = selected_data[:, SELECTED_COLUMNS]

    # SELECTED_COLUMNS = [
    #     1,
    #     2,
    #     3,
    #     4,
    #     5,
    #     6,
    #     7,
    #     9,
    #     10,
    #     12,
    #     13,
    #     14,
    #     15,
    #     16,
    #     17,
    #     18,
    #     20,
    #     22,
    #     23,
    #     24,
    #     25,
    #     26,
    #     27,
    #     28,
    #     29,
    #     32,
    #     33,
    #     34,
    #     35,
    #     36,
    #     38,
    #     39,
    #     40,
    #     41,
    #     42,
    #     43,
    #     46,
    #     47,
    #     48,
    #     49,
    #     50,
    #     51,
    #     52,
    #     53,
    #     54,
    #     55,
    #     56,
    #     57,
    #     58,
    #     59,
    #     60,
    #     61,
    #     62,
    #     63,
    #     64,
    #     65,
    #     66,
    #     67,
    #     68,
    #     69,
    #     70,
    #     71,
    #     72,
    #     74,
    #     75,
    #     76,
    #     79,
    #     80,
    #     82,
    #     83,
    #     84,
    #     86,
    #     87,
    #     88,
    #     89,
    #     90,
    #     91,
    #     92,
    #     93,
    #     94,
    #     95,
    #     97,
    #     98,
    #     99,
    #     101,
    #     102,
    #     103,
    #     104,
    #     105,
    #     106,
    #     107,
    #     108,
    #     109,
    #     110,
    #     111,
    #     112,
    #     113,
    #     114,
    #     115,
    #     116,
    #     117,
    #     118,
    #     119,
    #     120,
    #     122,
    #     123,
    #     124,
    #     125,
    #     126,
    #     127,
    #     128,
    #     129,
    #     130,
    #     132,
    #     133,
    #     134,
    #     136,
    #     137,
    #     138,
    #     139,
    #     140,
    #     141,
    #     142,
    #     143,
    #     144,
    #     145,
    #     146,
    #     148,
    #     149,
    #     150,
    #     151,
    #     152,
    #     155,
    #     156,
    #     157,
    #     158,
    #     159,
    #     160,
    #     161,
    #     162,
    #     163,
    #     164,
    #     165,
    #     166,
    #     167,
    #     168,
    #     169,
    #     170,
    #     171,
    #     172,
    #     173,
    #     174,
    #     175,
    #     176,
    #     177,
    #     178,
    #     179,
    #     180,
    #     181,
    #     182,
    #     183,
    #     184,
    #     185,
    #     186,
    #     188,
    #     189,
    #     190,
    #     191,
    #     192,
    #     193,
    #     194,
    #     195,
    #     198,
    #     199,
    #     200,
    #     201,
    #     202,
    #     203,
    #     204,
    #     205,
    #     206,
    #     207,
    #     208,
    #     209,
    #     210,
    #     211,
    #     212,
    #     213,
    #     214,
    #     215,
    #     216,
    #     217,
    #     218,
    #     219,
    #     220,
    #     221,
    #     222,
    #     224,
    #     225,
    #     226,
    #     227,
    #     228,
    #     229,
    #     230,
    #     232,
    #     233,
    #     234,
    #     235,
    #     236,
    #     238,
    #     239,
    #     240,
    #     241,
    #     242,
    #     243,
    #     245,
    #     246,
    #     247,
    #     248,
    #     249,
    #     250,
    #     251,
    #     252,
    #     253,
    #     254,
    # ]

    # selected_data = selected_data[:, SELECTED_COLUMNS]

    return result


def retrieve_similar_images(query_histogram, knn_model):
    """
    Retrieves the most similar images based on a pre-fitted KNN model.

    Args:
        query_histogram (np.ndarray): The histogram of the query image.
        knn_model (KNeighborsClassifier): Pre-fitted KNN model.

    Returns:
        tuple: Distances and indices of the retrieved images.
    """
    # Reshape the query histogram to 2D array
    query_histogram = query_histogram.reshape(1, -1)

    # Find the k-nearest neighbors using the pre-fitted model
    distances, indices = knn_model.kneighbors(query_histogram)

    return distances.flatten(), indices.flatten()  # Return distances and indices


def process_image_histogram(image_index, histograms):
    """
    Extracts the histogram for a specific image based on its index in the dataset.

    Args:
        image_index (int): Index of the image in the dataset.
        histograms (np.ndarray): Array of histograms of all images.

    Returns:
        np.ndarray: The histogram of the queried image.
    """
    return histograms[image_index]  # Return the histogram of the query image


def retrieve_and_save_images_for_all_dataset():
    """
    Process each image in the dataset, retrieve similar images, and save them.
    The KNN model is initialized and fitted once for efficiency.
    """
    # Ensure the main output directory exists
    os.makedirs(RETRIEVED_IMAGES_PATH, exist_ok=True)

    # Load histograms from the CSV file
    histograms = load_histograms_from_csv(CSV_FILE_PATH)
    print(
        f"csv file with {histograms.shape[0]} rows and {histograms.shape[1]} columns loaded."
    )

    # Initialize and fit the KNN model once
    # K_NEIGHBORS from constants is used here for n_neighbors
    knn_model = KNeighborsClassifier(
        n_neighbors=K_NEIGHBORS + 1,  # +1 to account for excluding the query image
        metric="canberra",  # Using Canberra distance
        weights="distance",  # Weight neighbors by their distance
        algorithm="auto",  # Or 'auto' for the best choice
        n_jobs=-1,
    )
    # Fit the model with all histograms
    knn_model.fit(histograms, np.arange(histograms.shape[0]))

    start_time = time.time()

    # Iterate over all images in the dataset
    for i in range(histograms.shape[0]):
        # Retrieve the histogram for the current query image
        query_histogram = process_image_histogram(i, histograms)

        # Retrieve similar images using the pre-fitted KNN model
        distances, retrieved_indices = retrieve_similar_images(
            query_histogram, knn_model
        )

        # Retrieve corresponding image filenames
        image_filenames = [
            f"{index}{IMAGE_FILE_EXTENSION}" for index in retrieved_indices
        ]

        # Create a folder to save the retrieved images
        retrieval_folder = os.path.join(RETRIEVED_IMAGES_PATH, str(i))
        os.makedirs(retrieval_folder, exist_ok=True)

        # Save the retrieved images in the folder
        save_retrieved_images(image_filenames, retrieval_folder)

        # Save the retrieval rank information to CSV, excluding the query image
        save_retrieval_rank_csv(
            distances, image_filenames, retrieved_indices, i, retrieval_folder
        )

        print(f"Retrieved images for image {i} saved in '{retrieval_folder}'")

    end_time = time.time()

    print(f"Image retrieval finished in {end_time - start_time:.2f} seconds.")


def save_retrieved_images(retrieved_image_filenames, output_folder):
    """
    Save the retrieved images in the specified folder.

    Args:
        retrieved_image_filenames (list): List of filenames of the retrieved images.
        output_folder (str): Directory to save the retrieved images.
    """
    for image_filename in retrieved_image_filenames:
        source_path = os.path.join(IMAGE_DATASET_PATH, image_filename)
        destination_path = os.path.join(output_folder, image_filename)

        if os.path.exists(source_path):
            shutil.copyfile(source_path, destination_path)
        else:
            print(f"Source image '{source_path}' not found. Skipping.")


def save_retrieval_rank_csv(
    distances, image_filenames, retrieved_indices, query_index, output_folder
):
    """
    Save the retrieval rank, filename, and distance to a CSV file, excluding the query image itself.

    Args:
        distances (np.ndarray): Array of distances of the retrieved images.
        image_filenames (list): List of retrieved image filenames.
        retrieved_indices (np.ndarray): List of indices of the retrieved images.
        query_index (int): Index of the query image.
        output_folder (str): Directory to save the rank CSV.
    """
    rank_data = {"Retrieval Rank": [], "Retrieved Image Filename": [], "Distance": []}

    rank = 1
    for idx, (distance, image_filename, retrieved_idx) in enumerate(
        zip(distances, image_filenames, retrieved_indices)
    ):
        if retrieved_idx != query_index:  # Skip the query image
            rank_data["Retrieval Rank"].append(rank)
            rank_data["Retrieved Image Filename"].append(image_filename)
            rank_data["Distance"].append(distance)
            rank += 1

    # Save to CSV
    rank_csv_path = os.path.join(output_folder, "rank.csv")
    rank_df = pd.DataFrame(rank_data)
    rank_df.to_csv(rank_csv_path, index=False)
    # print(f"Rank CSV saved at '{rank_csv_path}'")